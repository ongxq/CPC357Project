
#include <WiFi.h>
#include <HTTPClient.h>

// ================= WIFI =================
// TODO: Replace with your WiFi credentials
const char* WIFI_SSID = "";         // <-- Add your WiFi SSID here
const char* WIFI_PASSWORD = "";     // <-- Add your WiFi password here

// ================= SUPABASE =================
// TODO: Replace with your Supabase project info
const char* SUPABASE_URL = "";      // <-- Add your Supabase REST URL here
const char* SUPABASE_KEY = "";      // <-- Add your Supabase anon/public key here

#define TRIG_PIN 5
#define ECHO_PIN 17
#define RAIN_PIN 23

#define GREEN_LED 25
#define YELLOW_LED 26
#define RED_LED 27

// ----------- TANK CONFIGURATION -----------
const float BOTTOM_DISTANCE = 10.08;   // cm (sensor â†’ bottom when empty)
const float SENSOR_OFFSET   = 2.0;    // cm (sensor â†’ max water level gap)
const float USABLE_HEIGHT   = BOTTOM_DISTANCE - SENSOR_OFFSET;

const int NUM_SAMPLES = 5;

// Blockage detection
unsigned long highLevelStart = 0;
float lastWaterPercent = 0;

// ================= SEND TO SUPABASE =================
void sendToSupabase(float waterPercent,float waterDepth,float distance,  bool rainState, String status) {
  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("WiFi NOT connected");
    return;
  }

  HTTPClient http;
  http.begin(SUPABASE_URL);
  http.addHeader("Content-Type", "application/json");
  http.addHeader("apikey", SUPABASE_KEY);
  http.addHeader("Authorization", String("Bearer ") + SUPABASE_KEY);

  String json = "{";
  json += "\"water_level\":" + String(waterPercent, 1) + ",";
  json += "\"water_depth\":" + String(waterDepth, 2) + ",";
  json += "\"distance\":" + String(distance, 2) + ",";
  json += "\"rain_state\":" + String(rainState ? "true" : "false") + ",";
  json += "\"status\":\"" + status + "\"";
  json += "}";

  int code = http.POST(json);
  Serial.print("Supabase response: ");
  Serial.println(code);
  Serial.println(http.getString());

  http.end();
}

void setup() {
  Serial.begin(9600);

  pinMode(TRIG_PIN, OUTPUT);
  pinMode(ECHO_PIN, INPUT);
  pinMode(RAIN_PIN, INPUT);

  pinMode(GREEN_LED, OUTPUT);
  pinMode(YELLOW_LED, OUTPUT);
  pinMode(RED_LED, OUTPUT);

  Serial.println("Connecting WiFi...");
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
  while (WiFi.status() != WL_CONNECTED) {
    Serial.print(".");
    delay(500);
  }
  Serial.println("\nWiFi Connected!");

  Serial.println("=== Drain Monitor Started ===");
  Serial.print("Bottom distance: "); Serial.print(BOTTOM_DISTANCE); Serial.println(" cm");
  Serial.print("Sensor offset: "); Serial.print(SENSOR_OFFSET); Serial.println(" cm");
  Serial.print("Usable water height: "); Serial.print(USABLE_HEIGHT); Serial.println(" cm");
  delay(1000);
}

// ----------- ULTRASONIC FUNCTIONS -----------
float getDistance() {
  digitalWrite(TRIG_PIN, LOW);
  delayMicroseconds(2);
  digitalWrite(TRIG_PIN, HIGH);
  delayMicroseconds(10);
  digitalWrite(TRIG_PIN, LOW);

  long duration = pulseIn(ECHO_PIN, HIGH, 50000);
  if (duration == 0) return -1;

  return duration * 0.034 / 2;
}

float getAverageDistance() {
  float sum = 0;
  int count = 0;

  for (int i = 0; i < NUM_SAMPLES; i++) {
    float d = getDistance();
    if (d > 0) {
      sum += d;
      count++;
    }
    delay(50);
  }

  if (count == 0) return -1;
  return sum / count;
}

void loop() {
  float distance = getAverageDistance();

  if (distance < 0) {
    Serial.println("âš  Ultrasonic sensor error");
    delay(3000);
    return;
  }

  // ----------- LIMIT SENSOR BLIND ZONE -----------
  if (distance < SENSOR_OFFSET)
    distance = SENSOR_OFFSET;

  // ----------- WATER LEVEL CALCULATION -----------
  float waterDepth = USABLE_HEIGHT - (distance - SENSOR_OFFSET);
  waterDepth = constrain(waterDepth, 0, USABLE_HEIGHT);

  float waterPercent = (waterDepth / USABLE_HEIGHT) * 100.0;

  // ----------- RAIN SENSOR (ACTIVE-HIGH) -----------
  bool rainState = !digitalRead(RAIN_PIN); // HIGH = rain



  // ----------- DISPLAY -----------
  Serial.println("================================");
  Serial.print("Measured distance: "); Serial.print(distance, 2); Serial.println(" cm");
  Serial.print("Water depth: "); Serial.print(waterDepth, 2); Serial.println(" cm");
  Serial.print("Water level: "); Serial.print(waterPercent, 1); Serial.println(" %");
  Serial.println(rainState == HIGH ? "ðŸŒ§ Rain detected" : "â˜€ No rain");

  // ----------- LED CONTROL -----------
  digitalWrite(GREEN_LED, LOW);
  digitalWrite(YELLOW_LED, LOW);
  digitalWrite(RED_LED, LOW);

String status = "SAFE";

  if (waterPercent < 40) {
    status = "SAFE";
    digitalWrite(GREEN_LED, HIGH);
    
    highLevelStart = 0;
  }
  else if (waterPercent < 70) {
    status = "CAUTION";
    digitalWrite(YELLOW_LED, HIGH);
    //Serial.println("Status: CAUTION (Yellow)");
  }
  else {
    status = "CRITICAL";
    digitalWrite(RED_LED, HIGH);
    //Serial.println("Status: CRITICAL (Red)");

    if (highLevelStart == 0)
      highLevelStart = millis();

    if (millis() - highLevelStart > 172800000) {
      Serial.println("âš  BLOCKAGE DETECTED (48h high water)");
    }
  }

  // ----------- RAPID RISE ALERT -----------
  if (waterPercent > lastWaterPercent + 20) {
    Serial.println("ðŸš¨ RAPID WATER LEVEL RISE!");

    for (int i = 0; i < 3; i++) {
      digitalWrite(RED_LED, HIGH);
      delay(300);
      digitalWrite(RED_LED, LOW);
      delay(300);
    }
  }

  // ----------- RAIN + HIGH WATER ALERT -----------
  if (rainState == HIGH && waterPercent >= 40) {
    Serial.println("ðŸŒ§âš  RAIN + HIGH WATER â€” Check drain!");
  }

  Serial.println("================================\n");
  sendToSupabase(waterPercent, waterDepth,distance, rainState, status);

  lastWaterPercent = waterPercent; 
  delay(5000);
}
